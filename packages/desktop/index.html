<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recrate</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #FFFFFF;
      --bg-secondary: #F5F5F7;
      --bg-tertiary: #E8E8ED;
      --text-primary: #1D1D1F;
      --text-secondary: #86868B;
      --accent-blue: #007AFF;
      --accent-green: #34C759;
      --accent-red: #FF3B30;
      --separator: rgba(60, 60, 67, 0.12);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }

    #app {
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #status-screen {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      padding-left: 78px; /* Space for macOS traffic lights */
      border-bottom: 1px solid var(--separator);
      background: var(--bg-primary);
      -webkit-app-region: drag; /* Make header draggable */
      flex-shrink: 0; /* Prevent header from shrinking */
    }

    .header * {
      -webkit-app-region: no-drag; /* Make buttons clickable */
    }

    .app-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .app-icon {
      width: 28px;
      height: 28px;
      border-radius: 6px;
    }

    .app-name {
      font-size: 17px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-red);
    }

    .status-dot.running {
      background: var(--accent-green);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      min-height: 0; /* Important for flex overflow */
    }

    /* Cards */
    .card {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
    }

    .card-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Connection Badge */
    .connection-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      background: rgba(0, 122, 255, 0.1);
      color: var(--accent-blue);
    }

    .connection-badge svg {
      width: 12px;
      height: 12px;
    }

    .connection-badge.local {
      background: rgba(52, 199, 89, 0.1);
      color: var(--accent-green);
    }

    .connection-badge.cloud {
      background: rgba(0, 122, 255, 0.1);
      color: var(--accent-blue);
    }

    .connection-badge.tailscale {
      background: rgba(88, 86, 214, 0.1);
      color: #5856D6;
    }

    /* QR Section */
    .qr-wrapper {
      background: var(--bg-primary);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      justify-content: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      margin-bottom: 12px;
    }

    .qr-code {
      display: block;
    }

    .connection-url {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      color: var(--text-primary);
      cursor: pointer;
      transition: background 0.15s ease;
      border: none;
      width: 100%;
      text-align: center;
    }

    .connection-url:hover {
      background: #DCDCE0;
    }

    .connection-url:active {
      background: #D1D1D5;
    }

    .connection-url svg {
      opacity: 0;
      transition: opacity 0.15s ease;
      flex-shrink: 0;
    }

    .connection-url:hover svg {
      opacity: 1;
    }

    .connection-hint {
      text-align: center;
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 10px;
    }

    /* Stats Card */
    .stats-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--separator);
    }

    .stats-row:last-child {
      border-bottom: none;
    }

    .stats-label {
      font-size: 14px;
      color: var(--text-primary);
    }

    .stats-value {
      font-size: 14px;
      color: var(--text-secondary);
      font-variant-numeric: tabular-nums;
    }

    /* Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
    }

    .empty-state-title {
      font-size: 17px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .empty-state-hint {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Action Bar */
    .action-bar {
      display: flex;
      gap: 10px;
      padding: 16px;
      background: var(--bg-primary);
      border-top: 1px solid var(--separator);
      flex-shrink: 0; /* Prevent action bar from shrinking */
    }

    .btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .btn svg {
      width: 16px;
      height: 16px;
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--accent-blue);
    }

    .btn-secondary:hover {
      background: var(--bg-tertiary);
    }

    .btn-primary {
      background: var(--accent-blue);
      color: #FFFFFF;
    }

    .btn-primary:hover {
      background: #0066D6;
    }

    .btn-danger {
      background: var(--accent-red);
      color: #FFFFFF;
    }

    .btn-danger:hover {
      background: #E6352B;
    }

    /* Settings Screen */
    .settings-screen {
      display: none;
      height: 100vh;
      flex-direction: column;
    }

    .settings-screen.active {
      display: flex;
    }

    .settings-header {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px 16px;
      padding-left: 78px; /* Space for macOS traffic lights */
      border-bottom: 1px solid var(--separator);
      -webkit-app-region: drag;
    }

    .settings-header * {
      -webkit-app-region: no-drag;
    }

    .settings-title {
      font-size: 17px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-group {
      padding: 16px;
      border-bottom: 1px solid var(--separator);
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--separator);
      border-radius: 8px;
      font-size: 14px;
      color: var(--text-primary);
      font-family: inherit;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
    }

    .path-input {
      display: flex;
      gap: 8px;
    }

    .path-input .form-input {
      flex: 1;
    }

    .path-input .btn {
      flex: none;
      padding: 10px 16px;
    }

    /* Hide elements */
    .hidden {
      display: none !important;
    }

    /* Error Toast */
    .error-toast {
      position: fixed;
      bottom: 80px;
      left: 16px;
      right: 16px;
      background: var(--accent-red);
      color: #FFFFFF;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      z-index: 1000;
      display: none;
      animation: slideUp 0.3s ease;
      box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
    }

    .error-toast.visible {
      display: block;
    }

    .error-toast-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .error-toast-message {
      opacity: 0.9;
      word-break: break-word;
    }

    .error-toast-close {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      color: #FFFFFF;
      cursor: pointer;
      padding: 4px;
      opacity: 0.7;
    }

    .error-toast-close:hover {
      opacity: 1;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Button loading state */
    .btn.loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .btn.loading .btn-text {
      display: none;
    }

    .btn .btn-loading {
      display: none;
    }

    .btn.loading .btn-loading {
      display: inline;
    }

    /* Setup Wizard Error */
    .setup-error {
      background: rgba(255, 59, 48, 0.1);
      color: var(--accent-red);
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 16px;
      border: 1px solid rgba(255, 59, 48, 0.2);
    }

    /* Setup Wizard Screen */
    #setup-screen {
      display: none;
      height: 100vh;
      flex-direction: column;
    }

    #setup-screen.active {
      display: flex;
    }

    .setup-header {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px 16px;
      padding-left: 78px;
      border-bottom: 1px solid var(--separator);
      -webkit-app-region: drag;
    }

    .setup-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 24px;
      overflow-y: auto;
    }

    .setup-progress {
      margin-bottom: 32px;
    }

    .step-indicator {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: block;
      text-align: center;
    }

    .progress-bar {
      height: 4px;
      background: var(--bg-tertiary);
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent-blue);
      transition: width 0.3s ease;
    }

    .setup-step {
      display: none;
      flex: 1;
      flex-direction: column;
      text-align: center;
    }

    .setup-step.active {
      display: flex;
    }

    .step-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .setup-step h2 {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .step-description {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 24px;
      line-height: 1.5;
    }

    .step-description code {
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'SF Mono', 'Monaco', monospace;
      font-size: 13px;
    }

    .setup-path-group {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }

    .setup-path-group input {
      flex: 1;
      padding: 12px 14px;
      border: 1px solid var(--separator);
      border-radius: 10px;
      font-size: 13px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: 'SF Mono', 'Monaco', monospace;
    }

    .setup-path-group .btn {
      flex: none;
      padding: 12px 18px;
    }

    .step-actions {
      margin-top: auto;
      display: flex;
      gap: 12px;
      padding-top: 24px;
    }

    .step-actions .btn {
      flex: 1;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Status Screen -->
    <div id="status-screen">
      <!-- Header -->
      <header class="header">
        <div class="app-title">
          <img src="assets/icons/icon-128.png" class="app-icon" alt="Recrate">
          <span class="app-name">Recrate</span>
        </div>
        <div class="status-indicator">
          <span id="status-dot" class="status-dot"></span>
          <span id="status-text">Stopped</span>
        </div>
      </header>

      <!-- Main Content -->
      <main class="main-content">
        <!-- QR Card (hidden when stopped) -->
        <section id="qr-section" class="card hidden">
          <div class="card-header">
            <span class="card-title">Scan to Connect</span>
            <span id="connection-badge" class="connection-badge local">
              <svg id="connection-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
              </svg>
              <span id="connection-label">Local</span>
            </span>
          </div>

          <div class="qr-wrapper">
            <canvas id="qr-code" class="qr-code" width="160" height="160"></canvas>
          </div>

          <button id="connection-url" class="connection-url" onclick="copyURL()">
            <span id="url-text">http://loading...</span>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
              <rect x="9" y="9" width="13" height="13" rx="2"/>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
            </svg>
          </button>

          <div class="connection-hint">Click URL to copy</div>
        </section>

        <!-- Stats Card (hidden when stopped) -->
        <section id="stats-section" class="card hidden">
          <div class="card-header">
            <span class="card-title">Library</span>
          </div>
          <div class="stats-row">
            <span class="stats-label">Tracks</span>
            <span id="stat-tracks" class="stats-value">--</span>
          </div>
          <div class="stats-row">
            <span class="stats-label">Crates</span>
            <span id="stat-crates" class="stats-value">--</span>
          </div>
          <div class="stats-row">
            <span class="stats-label">Connection</span>
            <span id="stat-connection" class="stats-value">--</span>
          </div>
        </section>

        <!-- Empty State (shown when stopped) -->
        <div id="empty-state" class="empty-state">
          <p class="empty-state-title">Server Stopped</p>
          <p class="empty-state-hint">Press Start to begin streaming</p>
        </div>
      </main>

      <!-- Action Bar -->
      <footer class="action-bar">
        <button id="settings-btn" class="btn btn-secondary" onclick="showSettings()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
          Settings
        </button>
        <button id="toggle-btn" class="btn btn-primary" onclick="toggleServer()">
          <svg id="toggle-icon" viewBox="0 0 24 24" fill="currentColor">
            <polygon points="5 3 19 12 5 21"/>
          </svg>
          <span id="toggle-text">Start</span>
        </button>
      </footer>
    </div>

    <!-- Settings Screen -->
    <div id="settings-screen" class="settings-screen">
      <header class="settings-header">
        <span class="settings-title" onclick="toggleDebugPanel()" style="cursor: pointer;">Settings</span>
      </header>

      <div class="main-content">
        <div class="form-group">
          <label class="form-label">Serato Library Path</label>
          <div class="path-input">
            <input type="text" id="serato-path" class="form-input" readonly>
            <button class="btn btn-secondary" onclick="selectSeratoPath()">Browse</button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Music Files Path</label>
          <div class="path-input">
            <input type="text" id="music-path" class="form-input" readonly>
            <button class="btn btn-secondary" onclick="selectMusicPath()">Browse</button>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Port</label>
          <input type="number" id="port" class="form-input" value="3000">
        </div>
      </div>

      <footer class="action-bar">
        <button class="btn btn-secondary" onclick="showStatus()">Cancel</button>
        <button class="btn btn-primary" onclick="saveSettings()">Save</button>
      </footer>

      <!-- Debug info (hidden by default, triple-click settings title to show) -->
      <div id="debug-panel" class="hidden" style="padding: 16px; background: #f5f5f5; font-size: 11px; font-family: monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto;"></div>
    </div>

    <!-- Setup Wizard Screen -->
    <div id="setup-screen">
      <header class="setup-header">
        <div class="app-title">
          <img src="assets/icons/icon-128.png" class="app-icon" alt="Recrate">
          <span class="app-name">Welcome to Recrate</span>
        </div>
      </header>

      <div class="setup-container">
        <!-- Progress indicator -->
        <div class="setup-progress">
          <span class="step-indicator">Step <span id="current-step">1</span> of 2</span>
          <div class="progress-bar">
            <div id="progress-fill" class="progress-fill" style="width: 50%"></div>
          </div>
        </div>

        <!-- Error message -->
        <div id="setup-error" class="setup-error hidden"></div>

        <!-- Step 1: Serato Path -->
        <div id="setup-step-1" class="setup-step active">
          <div class="step-icon">üìÅ</div>
          <h2>Serato Library Path</h2>
          <p class="step-description">
            Where is your <code>_Serato_</code> folder located?<br>
            This contains your crates, playlists, and track analysis data.
          </p>
          <div class="setup-path-group">
            <input type="text" id="setup-serato-path" readonly placeholder="Select your Serato folder...">
            <button class="btn btn-secondary" onclick="browseSetupSerato()">Browse</button>
          </div>
          <div class="step-actions">
            <button id="setup-next-1" class="btn btn-primary" onclick="validateAndGoToStep2()">Next ‚Üí</button>
          </div>
        </div>

        <!-- Step 2: Music Path -->
        <div id="setup-step-2" class="setup-step">
          <div class="step-icon">üéµ</div>
          <h2>Music Files Path</h2>
          <p class="step-description">
            Where are your music files stored?<br>
            This is where your MP3, FLAC, and other audio files live.
          </p>
          <div class="setup-path-group">
            <input type="text" id="setup-music-path" readonly placeholder="Select your music folder...">
            <button class="btn btn-secondary" onclick="browseSetupMusic()">Browse</button>
          </div>
          <div class="step-actions">
            <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Back</button>
            <button id="setup-finish" class="btn btn-primary" onclick="finishSetup()">Finish</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Toast -->
  <div id="error-toast" class="error-toast">
    <button class="error-toast-close" onclick="hideError()">‚úï</button>
    <div class="error-toast-header">
      <span>Server Error</span>
    </div>
    <div id="error-message" class="error-toast-message"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
  <script>
    // API reference
    const api = window.electronAPI;
    let serverStatus = 'stopped';
    let serverUrl = '';
    let currentConnectionType = 'local';

    // SVG Icons
    const ICONS = {
      play: '<svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21"/></svg>',
      stop: '<svg viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>',
      home: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>',
      cloud: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>',
      globe: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>'
    };

    // Error toast timeout reference
    let errorTimeout = null;

    // Show error toast to user
    function showError(message) {
      const toast = document.getElementById('error-toast');
      const messageEl = document.getElementById('error-message');

      messageEl.textContent = message;
      toast.classList.add('visible');

      // Reset button loading state on error
      setButtonLoading(false);

      // Auto-hide after 10 seconds
      if (errorTimeout) clearTimeout(errorTimeout);
      errorTimeout = setTimeout(hideError, 10000);
    }

    // Hide error toast
    function hideError() {
      const toast = document.getElementById('error-toast');
      toast.classList.remove('visible');
      if (errorTimeout) {
        clearTimeout(errorTimeout);
        errorTimeout = null;
      }
    }

    // Set button loading state
    function setButtonLoading(loading) {
      const btn = document.getElementById('toggle-btn');
      const text = document.getElementById('toggle-text');

      if (loading) {
        btn.classList.add('loading');
        btn.disabled = true;
        text.textContent = 'Starting...';
      } else {
        btn.classList.remove('loading');
        btn.disabled = false;
      }
    }

    // Initialize
    async function init() {
      // Check if setup is complete
      const setupComplete = await api.getSetupComplete();

      if (!setupComplete) {
        // Show setup wizard
        showSetupWizard();
        return;
      }

      // Normal initialization
      await loadConfig();
      await updateServerStatus();

      // Auto-start server if configured
      const config = await api.getConfig();
      if (config.autoStart) {
        await api.startServer();
      }

      // Poll for status
      setInterval(updateServerStatus, 2000);

      // Listen for server status changes
      api.onServerStatus(async (status) => {
        serverStatus = status.status;
        serverUrl = status.localURL || status.url;
        await updateUI(status);
      });

      // Listen for logs
      api.onServerLog((log) => {
        console.log('Server log:', log);
      });

      // Listen for server errors - CRITICAL: display errors to user
      api.onServerError((error) => {
        console.error('Server error:', error);
        showError(error);
      });
    }

    // === Setup Wizard Functions ===

    // Show setup error message
    function showSetupError(message) {
      const el = document.getElementById('setup-error');
      el.textContent = message;
      el.classList.remove('hidden');
    }

    // Hide setup error message
    function hideSetupError() {
      document.getElementById('setup-error').classList.add('hidden');
    }

    async function showSetupWizard() {
      // Hide other screens
      document.getElementById('status-screen').style.display = 'none';
      document.getElementById('settings-screen').classList.remove('active');
      document.getElementById('setup-screen').classList.add('active');

      // Clear any previous errors
      hideSetupError();

      // Load auto-detected paths
      const config = await api.getConfig();
      document.getElementById('setup-serato-path').value = config.seratoPath || '';
      document.getElementById('setup-music-path').value = config.musicPath || '';
    }

    function goToStep(stepNum) {
      // Hide all steps
      document.querySelectorAll('.setup-step').forEach(s => s.classList.remove('active'));
      // Show target step
      document.getElementById(`setup-step-${stepNum}`).classList.add('active');
      // Update progress
      document.getElementById('current-step').textContent = stepNum;
      document.getElementById('progress-fill').style.width = `${stepNum * 50}%`;
      // Clear errors when changing steps
      hideSetupError();
    }

    // Validate Serato path before going to step 2
    async function validateAndGoToStep2() {
      const seratoPath = document.getElementById('setup-serato-path').value;

      if (!seratoPath) {
        showSetupError('Please select your Serato library folder.');
        return;
      }

      const exists = await api.validatePath(seratoPath);
      if (!exists) {
        showSetupError('Serato folder not found at this location. Please select a valid _Serato_ folder.');
        return;
      }

      hideSetupError();
      goToStep(2);
    }

    async function browseSetupSerato() {
      const path = await api.selectDirectory('Select Serato Library Folder');
      if (path) {
        document.getElementById('setup-serato-path').value = path;
        hideSetupError(); // Clear error when user selects a new path
      }
    }

    async function browseSetupMusic() {
      const path = await api.selectDirectory('Select Music Folder');
      if (path) {
        document.getElementById('setup-music-path').value = path;
        hideSetupError(); // Clear error when user selects a new path
      }
    }

    async function finishSetup() {
      // Get paths from setup inputs
      const seratoPath = document.getElementById('setup-serato-path').value;
      const musicPath = document.getElementById('setup-music-path').value;

      // Validate music path
      if (!musicPath) {
        showSetupError('Please select your music folder.');
        return;
      }

      const exists = await api.validatePath(musicPath);
      if (!exists) {
        showSetupError('Music folder not found at this location. Please select a valid folder.');
        return;
      }

      hideSetupError();

      // Save config
      const config = await api.getConfig();
      await api.saveConfig({
        ...config,
        seratoPath: seratoPath,
        musicPath: musicPath,
      });

      // Mark setup as complete
      await api.setSetupComplete();

      // Hide setup screen
      document.getElementById('setup-screen').classList.remove('active');

      // Show status screen and load config
      document.getElementById('status-screen').style.display = 'flex';
      await loadConfig();

      // Start the server
      await api.startServer();

      // Start polling for status
      setInterval(updateServerStatus, 2000);

      // Listen for server status changes
      api.onServerStatus(async (status) => {
        serverStatus = status.status;
        serverUrl = status.localURL || status.url;
        await updateUI(status);
      });

      api.onServerLog(() => {});
      api.onServerError(() => {});
    }

    // Load config
    async function loadConfig() {
      const config = await api.getConfig();
      document.getElementById('serato-path').value = config.seratoPath;
      document.getElementById('music-path').value = config.musicPath;
      document.getElementById('port').value = config.port;
    }

    // Update server status
    async function updateServerStatus() {
      const status = await api.getServerStatus();
      serverStatus = status.status;
      serverUrl = status.url;
      updateUI();
    }

    // Update UI based on status
    async function updateUI(statusData) {
      const statusDot = document.getElementById('status-dot');
      const statusText = document.getElementById('status-text');
      const qrSection = document.getElementById('qr-section');
      const statsSection = document.getElementById('stats-section');
      const emptyState = document.getElementById('empty-state');
      const toggleBtn = document.getElementById('toggle-btn');
      const toggleIcon = document.getElementById('toggle-icon');
      const toggleText = document.getElementById('toggle-text');

      // Reset button loading state when status is confirmed
      setButtonLoading(false);

      // Show error if status includes an error
      if (statusData?.error) {
        showError(statusData.error);
      }

      if (serverStatus === 'running') {
        // Update status indicator
        statusDot.classList.add('running');
        statusText.textContent = 'Running';

        // Show content, hide empty state
        qrSection.classList.remove('hidden');
        statsSection.classList.remove('hidden');
        emptyState.classList.add('hidden');

        // Update button
        toggleBtn.className = 'btn btn-danger';
        toggleIcon.innerHTML = ICONS.stop;
        toggleText.textContent = 'Stop';

        // Get connection info
        const proxyStatus = await api.getProxyStatus();
        const tailscaleInfo = await api.getTailscaleInfo();
        const localURL = statusData?.localURL || serverUrl;

        // Determine best connection and update UI
        let displayURL = localURL;
        let connectionType = 'local';

        if (proxyStatus.connected && proxyStatus.url) {
          displayURL = proxyStatus.url;
          connectionType = 'cloud';
        } else if (tailscaleInfo.running && tailscaleInfo.ip) {
          displayURL = statusData?.tailscaleHTTPSURL ||
                       tailscaleInfo.httpsURL ||
                       statusData?.tailscaleURL ||
                       `http://${tailscaleInfo.ip}:3000`;
          connectionType = 'tailscale';
        }

        // Update connection badge
        updateConnectionBadge(connectionType);

        // Update URL display
        document.getElementById('url-text').textContent = displayURL;

        // Update stats
        document.getElementById('stat-connection').textContent =
          connectionType === 'cloud' ? 'Cloud Proxy' :
          connectionType === 'tailscale' ? 'Tailscale' : 'Local Network';

        // Fetch library stats from server
        fetchLibraryStats();

        // Generate QR code
        generateQR(displayURL);

      } else {
        // Update status indicator
        statusDot.classList.remove('running');
        statusText.textContent = 'Stopped';

        // Hide content, show empty state
        qrSection.classList.add('hidden');
        statsSection.classList.add('hidden');
        emptyState.classList.remove('hidden');

        // Update button
        toggleBtn.className = 'btn btn-primary';
        toggleIcon.innerHTML = ICONS.play;
        toggleText.textContent = 'Start';
      }
    }

    // Update connection badge
    function updateConnectionBadge(type) {
      const badge = document.getElementById('connection-badge');
      const icon = document.getElementById('connection-icon');
      const label = document.getElementById('connection-label');

      badge.className = 'connection-badge ' + type;

      if (type === 'cloud') {
        icon.innerHTML = ICONS.cloud;
        label.textContent = 'Cloud';
      } else if (type === 'tailscale') {
        icon.innerHTML = ICONS.globe;
        label.textContent = 'Tailscale';
      } else {
        icon.innerHTML = ICONS.home;
        label.textContent = 'Local';
      }
    }

    // Fetch library stats from server
    async function fetchLibraryStats() {
      try {
        // Get the local server URL
        const status = await api.getServerStatus();
        if (status.status !== 'running' || !status.url) return;

        const response = await fetch(`${status.url}/api/library`);
        if (response.ok) {
          const data = await response.json();
          const trackCount = data.tracks ? data.tracks.length : 0;
          document.getElementById('stat-tracks').textContent = trackCount.toLocaleString();
        }

        // Fetch crates
        const cratesResponse = await fetch(`${status.url}/api/crates`);
        if (cratesResponse.ok) {
          const cratesData = await cratesResponse.json();
          const crateCount = cratesData.crates ? cratesData.crates.length : 0;
          document.getElementById('stat-crates').textContent = crateCount.toLocaleString();
        }
      } catch (error) {
        console.log('Could not fetch library stats:', error.message);
      }
    }

    // Generate QR code
    function generateQR(url) {
      const canvas = document.getElementById('qr-code');
      if (!canvas) return;

      let qrData;
      try {
        const urlObj = new URL(url);
        if (url.startsWith('https://') || url.includes('/api/')) {
          qrData = url;
        } else {
          const ip = urlObj.hostname;
          const port = urlObj.port || '3000';
          qrData = `recrate://connect?ip=${ip}&port=${port}`;
        }

        const qr = qrcode(0, 'M');
        qr.addData(qrData);
        qr.make();

        const size = 160;
        const moduleCount = qr.getModuleCount();
        const cellSize = size / moduleCount;

        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');

        // White background
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, size, size);

        // Draw QR modules
        for (let row = 0; row < moduleCount; row++) {
          for (let col = 0; col < moduleCount; col++) {
            if (qr.isDark(row, col)) {
              ctx.fillStyle = '#1D1D1F';
              ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
            }
          }
        }
      } catch (error) {
        console.error('Error generating QR code:', error);
      }
    }

    // Toggle server
    async function toggleServer() {
      try {
        if (serverStatus === 'running') {
          setButtonLoading(true);
          document.getElementById('toggle-text').textContent = 'Stopping...';
          await api.stopServer();
        } else {
          setButtonLoading(true);
          await api.startServer();
        }
        setTimeout(updateServerStatus, 1000);
      } catch (error) {
        console.error('Toggle server error:', error);
        showError(error.message || 'Failed to toggle server');
      }
    }

    // Copy URL
    function copyURL() {
      const urlText = document.getElementById('url-text').textContent;
      navigator.clipboard.writeText(urlText).then(() => {
        const btn = document.getElementById('connection-url');
        const originalText = document.getElementById('url-text').textContent;
        document.getElementById('url-text').textContent = 'Copied!';
        setTimeout(() => {
          document.getElementById('url-text').textContent = originalText;
        }, 1500);
      });
    }

    // Show settings
    function showSettings() {
      document.getElementById('status-screen').style.display = 'none';
      document.getElementById('settings-screen').classList.add('active');
    }

    // Show status
    function showStatus() {
      document.getElementById('settings-screen').classList.remove('active');
      document.getElementById('status-screen').style.display = 'flex';
    }

    // Select Serato path
    async function selectSeratoPath() {
      const path = await api.selectDirectory('Select Serato Library Folder');
      if (path) {
        document.getElementById('serato-path').value = path;
      }
    }

    // Select music path
    async function selectMusicPath() {
      const path = await api.selectDirectory('Select Music Folder');
      if (path) {
        document.getElementById('music-path').value = path;
      }
    }

    // Show debug diagnostics (triple-click settings title to activate)
    let settingsClickCount = 0;
    let settingsClickTimer = null;

    async function toggleDebugPanel() {
      settingsClickCount++;
      if (settingsClickTimer) clearTimeout(settingsClickTimer);
      settingsClickTimer = setTimeout(() => { settingsClickCount = 0; }, 500);

      if (settingsClickCount >= 3) {
        settingsClickCount = 0;
        const panel = document.getElementById('debug-panel');
        if (panel.classList.contains('hidden')) {
          try {
            const diag = await api.getDiagnostics();
            panel.textContent = JSON.stringify(diag, null, 2);
            panel.classList.remove('hidden');
          } catch (e) {
            panel.textContent = 'Error getting diagnostics: ' + e.message;
            panel.classList.remove('hidden');
          }
        } else {
          panel.classList.add('hidden');
        }
      }
    }

    // Save settings
    async function saveSettings() {
      const config = {
        seratoPath: document.getElementById('serato-path').value,
        musicPath: document.getElementById('music-path').value,
        port: parseInt(document.getElementById('port').value),
        autoStart: true
      };

      await api.saveConfig(config);
      alert('Settings saved! Restart the server for changes to take effect.');
      showStatus();
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
